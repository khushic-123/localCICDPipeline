version: 2.1

jobs:
  maven-test:
    docker:
      - image: cimg/openjdk:17.0  # Java 17
    environment:
      LT_USERNAME: $LT_USERNAME   # LambdaTest username from CircleCI project settings
      LT_ACCESS_KEY: $LT_ACCESS_KEY  # LambdaTest access key from CircleCI project settings
    steps:
      - checkout

      # Cache Maven dependencies
      - restore_cache:
          keys:
            - maven-{{ checksum "pom.xml" }}
            - maven-

      # Install Maven
      - run:
          name: Install Maven
          command: |
            sudo apt-get update -y
            sudo apt-get install -y maven
            mvn -v

      # Start your local server in background
      - run:
          name: Start Local Server
          command: |
            java -jar target/LocalHostWebApp-1.0-SNAPSHOT.jar &
            sleep 10  # wait for server to start

      # Download and start LambdaTest tunnel
      - run:
          name: Start LambdaTest Tunnel
          command: |
            curl -o LT --silent https://downloads.lambdatest.com/automation/LT
            chmod +x LT
            ./LT --user $LT_USERNAME --key $LT_ACCESS_KEY --tunnelName myLocalTunnel &
            sleep 15  # wait for tunnel to connect

      # Run Maven tests
      - run:
          name: Run Maven Tests
          command: mvn -B clean test

      # Save Maven cache
      - save_cache:
          paths:
            - ~/.m2
          key: maven-{{ checksum "pom.xml" }}

workflows:
  version: 2
  test:
    jobs:
      - maven-test








