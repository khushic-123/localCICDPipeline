version: 2.1

jobs:
  maven-test:
    docker:
      - image: cimg/openjdk:17.0-browsers

    environment:
      LT_USERNAME: $LT_USERNAME
      LT_ACCESS_KEY: $LT_ACCESS_KEY

    steps:
      - checkout

      - restore_cache:
          keys:
            - maven-{{ checksum "pom.xml" }}
            - maven-

      - run:
          name: Verify index.html exists
          command: |
            echo "üìÇ Current directory: $(pwd)"
            ls -al
            if [ ! -f index.html ]; then
              echo "‚ùå index.html not found in root!"
              exit 1
            fi
      - run:
          name: Debug LT credentials
          command: |
            echo "LT_USERNAME is $LT_USERNAME"
            echo "LT_ACCESS_KEY is $LT_ACCESS_KEY"
      - run:
          name: Start Local HTTP Server
          command: |
            echo "üöÄ Starting local server on port 5500..."
            python3 -m http.server 5500 &
            sleep 5
            echo "‚úÖ Local server started."

      - run:
          name: Start LambdaTest Tunnel
          command: |
            wget https://downloads.lambdatest.com/tunnel/v3/linux/64bit/LT_Linux.zip
            unzip LT_Linux.zip
            chmod +x LT
            ./LT --user $LT_USERNAME --key $LT_ACCESS_KEY --tunnelName myLocalTunnel --verbose > lt.log 2>&1 &
            echo "‚è≥ Waiting for tunnel to connect..."
            until grep -q "Tunnel connected successfully" lt.log; do
              sleep 2
            done
            echo "‚úÖ Tunnel is connected!"

      - run:
          name: Run Maven tests
          command: mvn -B clean test

      - run:
          name: Stop LambdaTest Tunnel
          command: |
            echo "üõë Stopping LambdaTest Tunnel..."
            pkill LT || true

      - save_cache:
          paths:
            - .m2/repository
          key: maven-{{ checksum "pom.xml" }}

      - store_test_results:
          path: target/surefire-reports

      - store_artifacts:
          path: target

workflows:
  version: 2
  test-workflow:
    jobs:
      - maven-test








