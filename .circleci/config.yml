version: 2.1

jobs:
  maven-test:
    docker:
      - image: cimg/openjdk:17.0-browsers

    # ‚ùå FIX 1: Removed the redundant 'environment' block.
    # LT_USERNAME and LT_ACCESS_KEY must be set in the CircleCI UI/Context.

    steps:
      - checkout

      - restore_cache:
          keys:
            - maven-{{ checksum "pom.xml" }}
            - maven-

      - run:
          name: Verify index.html exists
          command: |
            echo "üìÇ Current directory: $(pwd)"
            ls -al
            if [ ! -f index.html ]; then
              echo "‚ùå index.html not found in root! Ensure it's checked out."
              exit 1
            fi

      - run:
          name: Debug LT credentials
          command: |
            echo "LT_USERNAME is not empty: ${LT_USERNAME:+YES}"
            echo "LT_ACCESS_ACCESS is not empty: ${LT_ACCESS_KEY:+YES}"

      - run:
          name: Start Local HTTP Server
          command: |
            echo "üöÄ Starting local server on port 5500..."
            # Change to '127.0.0.1' and use an explicit nohup to keep it running reliably
            # Note: 127.0.0.1 is safe here because the LT Tunnel client is on the same host (Docker container)
            nohup python3 -m http.server 5500 --bind 127.0.0.1 > python_server.log 2>&1 &
            
            # Add a verification step to confirm the server is responsive locally
            sleep 5
            echo "Verifying local server access..."
            curl -I http://127.0.0.1:5500/index.html
            
            echo "‚úÖ Local server started."

      - run:
          name: Start LambdaTest Tunnel (with 443 fix and polling)
          command: |
            echo "üîΩ Downloading LambdaTest Tunnel binary..."
            wget https://downloads.lambdatest.com/tunnel/v3/linux/64bit/LT_Linux.zip
            unzip LT_Linux.zip
            chmod +x LT
            
            echo "üöá Starting LambdaTest Tunnel..."
            # ‚úÖ FIX 3: Added --sshConnType over_443 and start in background
            ./LT --user $LT_USERNAME --key $LT_ACCESS_KEY --tunnelName myLocalTunnel --verbose --sshConnType over_443 > lt.log 2>&1 &
            
            # üí° FIX 4: Small initial pause for logging to start
            sleep 5
            
            echo "‚è≥ Waiting for tunnel to connect..."
            TIMEOUT=90
            for i in $(seq 1 $TIMEOUT); do
              # Check for the key phrase in the log file
              if grep -q "You can start testing now" lt.log; then
                echo "‚úÖ LambdaTest Tunnel is ready after $i seconds!"
                break
              fi
              sleep 1
            
              if [ $i -eq $TIMEOUT ]; then
                echo "‚ùå Tunnel failed to connect within $TIMEOUT seconds."
                tail -n 30 lt.log
                exit 1
              fi
            done
            echo "‚úÖ Tunnel log preview (Successful):"
            tail -n 30 lt.log

      - run:
          name: Run Maven tests
          command: mvn -B clean test

      - run:
          name: Display Test Report on Failure
          command: |
            echo "--- Displaying Surefire Error Report ---"
            # Adjust the filename pattern if needed, but this is the Maven default
            cat target/surefire-reports/TEST-org.example.LocalHtmlSeleniumTest.xml || true
            echo "----------------------------------------"
          when: always # IMPORTANT: Always run this step, even if the test step fails

      - run:
          name: Stop LambdaTest Tunnel and Python Server
          command: |
            echo "üõë Stopping LambdaTest Tunnel..."
            pkill LT || true
            echo "üõë Stopping Python Server..."
            pkill -f 'python3 -m http.server 5500' || true

      - save_cache:
          paths:
            - .m2/repository
          key: maven-{{ checksum "pom.xml" }}

      - store_test_results:
          path: target/surefire-reports

      - store_artifacts:
          path: target

workflows:
  version: 2
  test-workflow:
    jobs:
      - maven-test



